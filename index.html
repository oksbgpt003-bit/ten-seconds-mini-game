<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>10초 맞추기 게임</title>
  <style>
    /*
      10초 맞추기 게임 — 단일 HTML 파일 (롤백+정리 버전)
      - 모바일 우선 카드 UI, 큰 버튼(≥64px) 유지
      - 고정밀 타이머(performance.now) + rAF 표시 분리
      - 5.00s~7.00s 페이드아웃(2s)
      - 접근성: 라이브 리전/키보드 조작/포커스 링
      - reduced-motion 환경에서도 게임 중엔 시계 강제 동작(사용자 요청 반영)
    */

    :root {
      --bg: #0b1020;
      --card: #ffffff;
      --text: #0b1020;
      --muted: #5b647a;
      --primary: #1b5cff;
      --primary-press: #0c46d4;
      --primary-disabled: #aab8ff;
      --radius: 16px;
      --shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      --focus: 0 0 0 3px rgba(27, 92, 255, 0.35);
      --content-max: 720px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    .wrap {
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(24px, calc(env(safe-area-inset-bottom) + 16px)) max(16px, env(safe-area-inset-left));
    }

    .card {
      width: min(100%, var(--content-max));
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(16px, 5vw, 28px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: clamp(12px, 3vw, 20px);
    }

    .title { font-weight: 700; font-size: clamp(18px, 4.5vw, 24px); line-height: 1.2; }
    .desc { color: var(--muted); font-size: clamp(13px, 3.5vw, 15px); }

    .status-row { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: clamp(8px, 2.5vw, 14px); text-align: center; }
    .clock { width: clamp(96px, 40vw, 200px); height: clamp(96px, 40vw, 200px); flex: 0 0 auto; }

    .timer {
      font-variant-numeric: tabular-nums lining-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
      font-size: clamp(40px, 16vw, 96px);
      font-weight: 800;
      letter-spacing: 0.02em;
      line-height: 1;
      user-select: none;
      transition: opacity 2s linear; /* 5s에서 페이드 시작 → 2s 후(7s) 완전 투명 */
      text-align: center;
    }
    .timer.fade { opacity: 0; }

    .countdown { min-height: 28px; font-size: clamp(18px, 6vw, 28px); font-weight: 700; color: #b96d00; text-align: center; height: 1lh; }

    .result {
      color: var(--text);
      background: #f5f7ff;
      border: 1px solid #dde5ff;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: clamp(14px, 3.8vw, 16px);
      display: none;
    }

    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }

    button { appearance: none; border: none; border-radius: 14px; padding: 16px 18px; min-height: 64px; font-weight: 800; font-size: clamp(16px, 4.5vw, 18px); cursor: pointer; box-shadow: 0 2px 0 rgba(0,0,0,0.06); transition: transform 0.08s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease; }
    button:focus-visible { outline: none; box-shadow: var(--focus); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:active { transform: translateY(1px); background: var(--primary-press); }
    .btn-primary[disabled], .btn-primary[aria-disabled="true"] { background: var(--primary-disabled); color: #eef1ff; cursor: not-allowed; filter: grayscale(10%); }
    .btn-secondary { background: #e8ecff; color: #143269; border: 1px solid #cfd9ff; }
    .btn-secondary:active { transform: translateY(1px); }

    .hidden { display: none !important; }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } 75% { transform: translateX(-2px); } }
    .shake { animation: shake 180ms ease-in-out; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
      /* 단, 아래 강제 허용 스위치가 없을 때만 초침을 멈춘다 */
      :root:not(.force-motion) .clock-hand-second { animation: none !important; }
    }

    /* 초침 애니메이션: 0.8초에 한 바퀴, 시작 각도는 매번 랜덤 */
    .clock-hand-second { transform-box: view-box; transform-origin: center; animation: tick var(--sec-rot, 0.8s) linear infinite; animation-delay: var(--sec-delay, 0s); animation-play-state: paused; }
    #clock.animate .clock-hand-second { animation-play-state: running; }
    @keyframes tick { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="application" aria-label="10초 맞추기 게임">
      <div>
        <div class="title">10초 맞추기 게임</div>
        <p class="desc">카운트다운 후 10초에 맞춰 버튼을 눌러보세요.</p>
      </div>

      <section aria-labelledby="timer-section-heading">
        <h2 id="timer-section-heading" class="sr-only">스톱워치</h2>
        <div class="status-row" aria-live="off">
          <!-- 시계 아이콘 -->
          <svg id="clock" class="clock" viewBox="0 0 24 24" fill="none" role="img" aria-label="시계 아이콘(초침 애니메이션)" focusable="false">
            <defs>
              <filter id="clockShadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="1" stdDeviation="0.6" flood-color="#000" flood-opacity="0.15"/>
              </filter>
            </defs>
            <g filter="url(#clockShadow)">
              <circle cx="12" cy="12" r="9.2" stroke="#1b2b57" stroke-width="1.6" fill="#ffffff" />
              <g stroke="#1b2b57" stroke-linecap="round" opacity="0.9">
                <line x1="12" y1="2.8" x2="12" y2="4.6" stroke-width="1.4"/>
                <line x1="21.2" y1="12" x2="19.4" y2="12" stroke-width="1.4"/>
                <line x1="12" y1="21.2" x2="12" y2="19.4" stroke-width="1.4"/>
                <line x1="2.8" y1="12" x2="4.6" y2="12" stroke-width="1.4"/>
              </g>
              <g stroke="#1b2b57" stroke-width="0.8" stroke-linecap="round" opacity="0.45">
                <g transform="rotate(30 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(60 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(120 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(150 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(210 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(240 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(300 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
                <g transform="rotate(330 12 12)"><line x1="12" y1="3.6" x2="12" y2="4.8"/></g>
              </g>
            </g>
            <rect x="10.9" y="1.6" width="2.2" height="2.0" rx="0.3" fill="#1b2b57"/>
            <g class="clock-hand-second">
              <line x1="12" y1="12" x2="12" y2="3.6" stroke="#c62828" stroke-width="1.2" stroke-linecap="round"/>
              <line x1="12" y1="12" x2="12" y2="15.2" stroke="#c62828" stroke-width="0.9" stroke-linecap="round" opacity="0.8"/>
            </g>
            <circle cx="12" cy="12" r="1.1" fill="#1b2b57" />
          </svg>
          <div id="timerText" class="timer" role="timer" aria-live="off" aria-label="경과 시간 0.00초">0.00</div>
        </div>
        <div id="countdown" class="countdown" aria-live="assertive" aria-atomic="true"></div>
        <div id="live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
      </section>

      <section>
        <div id="result" class="result" role="status" aria-live="polite"></div>
      </section>

      <section class="actions">
        <button id="actionBtn" class="btn-primary" type="button" disabled aria-disabled="true" aria-describedby="actionHint">지금이다!</button>
        <button id="resetBtn" class="btn-secondary hidden" type="button">다시하기</button>
        <span id="actionHint" class="sr-only">스페이스 또는 엔터로도 누를 수 있습니다.</span>
      </section>
    </main>
  </div>

  <script>
    "use strict";
    /* ========= 설정(상수) ========= */
    const DEBUG = false;
    const TARGET_SECONDS = 10.00;
    const COUNTDOWN_SECONDS = 3.00;
    const FADE_START_SEC = 5.00;
    const FADE_END_SEC = 7.00; // CSS 전환으로 2s 후 완전 투명

    const GRADES = { god: 0.05, great: 0.10, good: 0.30 };

    /* ========= 상태 ========= */
    /** @type {'idle'|'countdown'|'running'|'ended'} */
    let phase = 'idle';
    let startTime = 0; let endTime = null; let rafId = 0; let countdownRaf = 0; let countdownStart = 0; let fadeApplied = false;

    /* ========= DOM ========= */
    const $timerText = document.getElementById('timerText');
    const $countdown = document.getElementById('countdown');
    const $live = document.getElementById('live');
    const $result = document.getElementById('result');
    const $actionBtn = document.getElementById('actionBtn');
    const $resetBtn = document.getElementById('resetBtn');
    const $clock = document.getElementById('clock');

    /* ========= 유틸 ========= */
    const log = (...args) => { if (DEBUG) console.log('[DEBUG]', ...args); };
    const msToSeconds = (ms) => ms / 1000;
    const roundTo2 = (n) => Math.round(n * 100) / 100;
    const formatSeconds = (seconds) => roundTo2(seconds).toFixed(2);
    const announce = (msg) => { $live.textContent = msg; log('Announce:', msg); };
    const setActionEnabled = (enabled) => { $actionBtn.disabled = !enabled; $actionBtn.setAttribute('aria-disabled', String(!enabled)); };
    const getGradeMessage = (absError) => absError <= GRADES.god ? '신의 손' : absError <= GRADES.great ? '대단해요' : absError <= GRADES.good ? '좋아요' : '다시 도전!';

    /* ========= 시계 애니메이션 토글 ========= */
    function setClockAnimating(on) {
      if (!$clock) return;
      if (on) {
        document.documentElement.classList.add('force-motion'); // reduced-motion이어도 게임 중엔 강제 동작
        $clock.style.setProperty('--sec-rot', '0.8s');
        const delay = `-${(Math.random() * 0.8).toFixed(3)}s`;
        $clock.style.setProperty('--sec-delay', delay);
      } else {
        document.documentElement.classList.remove('force-motion');
      }
      $clock.classList.toggle('animate', !!on);
    }

    /* ========= 게임 루프 ========= */
    function startCountdown() {
      phase = 'countdown';
      setClockAnimating(false); // 카운트다운 동안 시계 고정
      fadeApplied = false;
      $timerText.classList.remove('fade'); // 🔧 페이드 상태 확실히 해제
      $timerText.textContent = '0.00';
      $timerText.setAttribute('aria-label', '경과 시간 0.00초');
      $result.style.display = 'none';
      $result.textContent = '';
      setActionEnabled(false);
      $resetBtn.classList.add('hidden');

      countdownStart = performance.now();
      let started = false;
      function tick() {
        const now = performance.now();
        const elapsed = now - countdownStart;
        const remain = COUNTDOWN_SECONDS * 1000 - elapsed;
        if (remain > 2000) { $countdown.textContent = '3'; }
        else if (remain > 1000) { $countdown.textContent = '2'; }
        else if (remain > 0) { $countdown.textContent = '1'; }
        else {
          if (!started) {
            started = true;
            $countdown.textContent = '시작!';
            announce('시작! 지금 버튼을 누를 수 있습니다.');
            startTimer(now);
            setTimeout(() => { $countdown.textContent = ''; }, 650);
          }
        }
        if (phase === 'countdown' && !started) { countdownRaf = requestAnimationFrame(tick); }
      }
      cancelAnimationFrame(countdownRaf);
      tick();
    }

    function startTimer(startRefNow) {
      phase = 'running';
      setClockAnimating(true); // 러닝 중에만 시계 동작
      startTime = startRefNow ?? performance.now();
      endTime = null;
      setActionEnabled(true);
      $actionBtn.focus({ preventScroll: true });

      function update() {
        const now = performance.now();
        const elapsedSec = msToSeconds(now - startTime);
        const display = formatSeconds(elapsedSec);
        $timerText.textContent = display;
        $timerText.setAttribute('aria-label', `경과 시간 ${display}초`);
        if (!fadeApplied && elapsedSec >= FADE_START_SEC) { $timerText.classList.add('fade'); fadeApplied = true; }
        if (phase === 'running') { rafId = requestAnimationFrame(update); }
      }
      cancelAnimationFrame(rafId);
      update();
    }

    function stop() {
      if (phase !== 'running') return;
      phase = 'ended';
      setClockAnimating(false); // 종료 시 고정
      endTime = performance.now();
      cancelAnimationFrame(rafId);

      const seconds = msToSeconds(endTime - startTime);
      const record = roundTo2(seconds);
      const error = roundTo2(Math.abs(record - TARGET_SECONDS));
      const grade = getGradeMessage(error);
      const msg = `기록: ${record.toFixed(2)}초 / 오차: ${error.toFixed(2)}초 — ${grade}`;
      $result.textContent = msg;
      $result.style.display = 'block';
      announce(msg);

      setActionEnabled(false);
      $resetBtn.classList.remove('hidden');
    }

    function reset() {
      cancelAnimationFrame(rafId);
      cancelAnimationFrame(countdownRaf);
      phase = 'idle';
      startTime = 0; endTime = null; fadeApplied = false;
      $timerText.textContent = '0.00';
      $timerText.setAttribute('aria-label', '경과 시간 0.00초');
      $timerText.classList.remove('fade'); // 🔧 리셋 시 페이드 해제(초시계 사라짐 방지)
      $countdown.textContent = '';
      $result.textContent = '';
      $result.style.display = 'none';
      setActionEnabled(false);
      $resetBtn.classList.add('hidden');
      setClockAnimating(false);
      announce('새 게임이 시작됩니다. 3초 카운트다운 후 시작!');
      setTimeout(startCountdown, 100);
    }

    /* ========= 이벤트 ========= */
    $actionBtn.addEventListener('click', () => { if ($actionBtn.disabled) return; stop(); });
    window.addEventListener('keydown', (e) => {
      const isSpace = e.code === 'Space' || e.key === ' ';
      const isEnter = e.code === 'Enter' || e.key === 'Enter';
      if (!(isSpace || isEnter)) return;
      if (phase === 'running') { e.preventDefault(); stop(); }
      else if (phase === 'countdown') { e.preventDefault(); nudgeDisabledFeedback(); }
    });
    window.addEventListener('pointerdown', (e) => {
      if (!$actionBtn.disabled) return; const path = e.composedPath ? e.composedPath() : []; if (path.includes($actionBtn)) { nudgeDisabledFeedback(); }
    }, { capture: true });
    function nudgeDisabledFeedback() { $actionBtn.classList.remove('shake'); void $actionBtn.offsetWidth; $actionBtn.classList.add('shake'); if (navigator.vibrate) navigator.vibrate(30); }
    $resetBtn.addEventListener('click', () => reset());

    window.addEventListener('DOMContentLoaded', () => { announce('게임이 곧 시작됩니다. 3초 카운트다운.'); startCountdown(); });
  </script>
</body>
</html>
